name: Deploy Website to Server (SUDO POWERED)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1: 检出你的网站代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 步骤 2: 通过 SSH Action 部署文件
      - name: Deploy Files via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }} # 应该是 deployer
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 定义真实的网站根目录
            TARGET_DIR="/var/www/mywebsite"
            
            # --- 以下是在服务器上执行的命令 ---
            echo "🚀 Starting deployment as user: $(whoami) on server: $(hostname)"
            echo "Deployment target directory is set to: ${TARGET_DIR}"
            
            # 进入目标目录
            cd $TARGET_DIR || exit 1
            echo "Changed directory to: $(pwd)"
            
            # 使用 sudo 来清空旧文件
            echo "🧹 Cleaning up old files with sudo..."
            sudo find . -mindepth 1 -delete
            
            echo "✅ Cleanup successful. Ready for sync."
