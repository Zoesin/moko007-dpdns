name: Deploy Website to GCP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to GCP Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
      script: |
        # --- éƒ¨ç½²è„šæœ¬å¼€å§‹ ---
        echo "ğŸš€ Starting deployment as user: $(whoami)"
        
        # 1. å®šä¹‰æœåŠ¡å™¨ä¸Šçš„ç½‘ç«™æ ¹ç›®å½•
        TARGET_DIR="/var/www/html"
        echo "Deployment target directory is set to: ${TARGET_DIR}"
        
        # 2. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ (å› ä¸ºæˆ‘ä»¬æ˜¯ rootï¼Œä¸éœ€è¦ sudo)
        mkdir -p $TARGET_DIR
        
        # 3. è¿›å…¥ç›®æ ‡ç›®å½•
        cd $TARGET_DIR
        echo "Changed directory to: $(pwd)"
        
        # 4. æ¸…ç©ºæ—§æ–‡ä»¶ï¼Œè¿›è¡Œå…¨æ–°éƒ¨ç½²
        echo "ğŸ§¹ Cleaning up old files..."
        rm -rf ./*
        
        # 5. ä» GitHub Actions çš„å·¥ä½œåŒºå¤åˆ¶æ‰€æœ‰æ–°æ–‡ä»¶åˆ°æœåŠ¡å™¨
        #    ä½¿ç”¨ $GITHUB_WORKSPACE ç¯å¢ƒå˜é‡ï¼Œè¿™æ˜¯æ­£ç¡®çš„è¯­æ³•
        echo "ğŸ“‚ Copying new files from ${GITHUB_WORKSPACE}..."
        cp -r $GITHUB_WORKSPACE/* .
        
        # 6. å°†æ–‡ä»¶æ‰€æœ‰æƒèµ‹äºˆ Nginx è¿è¡Œçš„ç”¨æˆ· (é€šå¸¸æ˜¯ www-data)
        echo "ğŸ” Setting permissions for www-data user..."
        chown -R www-data:www-data $TARGET_DIR
        
        echo "âœ… Deployment successful!"
        # --- éƒ¨ç½²è„šæœ¬ç»“æŸ ---
