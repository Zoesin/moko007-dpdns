name: Deploy Website to GCP (Manual SSH)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä½ çš„ç½‘ç«™ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. ã€æ ¸å¿ƒã€‘å»ºç«‹ SSH è¿žæŽ¥å¹¶éƒ¨ç½²
      - name: Deploy via manual SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }} # åº”è¯¥å·²ç»æ˜¯ deployer
        run: |
          # --- å‡†å¤‡ SSH çŽ¯å¢ƒ ---
          echo "Setting up SSH..."
          # åˆ›å»º .ssh ç›®å½•
          mkdir -p ~/.ssh
          # å°†ç§é’¥ä»Ž Secret å†™å…¥æ–‡ä»¶
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          # è®¾ç½®ä¸¥æ ¼çš„ç§é’¥æ–‡ä»¶æƒé™
          chmod 600 ~/.ssh/id_rsa
          # ä¸ºäº†å®‰å…¨ï¼Œç¦ç”¨ä¸¥æ ¼çš„ä¸»æœºå¯†é’¥æ£€æŸ¥
          echo "Host ${SSH_HOST}" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

          # --- å¼€å§‹éƒ¨ç½² ---
          echo "Connecting to ${SSH_USERNAME}@${SSH_HOST}..."
          ssh "${SSH_USERNAME}@${SSH_HOST}" << 'EOF'
            # --- ä»¥ä¸‹æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„å‘½ä»¤ ---
            echo "ðŸš€ Starting deployment as user: $(whoami) on server: $(hostname)"
            
            # 1. å®šä¹‰ç½‘ç«™æ ¹ç›®å½•
            TARGET_DIR="/var/www/html"
            echo "Deployment target directory is set to: ${TARGET_DIR}"
            
            # 2. è¿›å…¥ç›®å½•
            cd $TARGET_DIR || exit 1
            echo "Changed directory to: $(pwd)"
            
            # 3. æ¸…ç©ºæ—§æ–‡ä»¶
            echo "ðŸ§¹ Cleaning up old files..."
            # ä½¿ç”¨ find å’Œ delete æ›´å®‰å…¨
            find . -mindepth 1 -delete
            
            # 4. åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æŠŠæ–‡ä»¶ä»Ž Actions Runner ä¼ åˆ°æœåŠ¡å™¨
            #    ç”±äºŽç›´æŽ¥ SSH è¿›åŽ»åŽæ— æ³•ä¼ æ–‡ä»¶ï¼Œæˆ‘ä»¬æ”¹ç”¨ rsync
            #    é€€å‡ºå½“å‰çš„ SSH ä¼šè¯
          EOF
          
          # --- ä½¿ç”¨ rsync ä¼ è¾“æ–‡ä»¶ (æœ€å¯é çš„æ–¹å¼) ---
          echo "Synchronizing files using rsync..."
          rsync -avz -e "ssh -i ~/.ssh/id_rsa" ./ "${SSH_USERNAME}@${SSH_HOST}:/var/www/html/"

          # --- å†æ¬¡ SSH è¿›åŽ»è®¾ç½®æœ€ç»ˆæƒé™ ---
          echo "Setting final permissions on server..."
          ssh "${SSH_USERNAME}@${SSH_HOST}" << 'EOF'
            TARGET_DIR="/var/www/html"
            echo "ðŸ” Setting permissions for www-data user..."
            # ä½¿ç”¨ sudo æ˜¯å› ä¸º deployer ç”¨æˆ·å¯èƒ½æ²¡æœ‰æƒé™ chown ç»™ www-data
            # æˆ‘ä»¬éœ€è¦ç»™ deployer ç”¨æˆ·å…å¯† sudo çš„æƒé™
            sudo chown -R www-data:www-data $TARGET_DIR
            echo "âœ… Deployment successful!"
          EOF
